#include <iostream>
#include <cstdlib>
#include <ctime>
#include "header.hpp"

using namespace std;
// i ballholder einai ousiastika i klasi megaluteris ierarxias apo oles tis klaseis pou exw ftiaksei
// exei ws skopo na dhmiourgei tis mpales, na krataei pinaka me mpales kai o,ti allo exei na kanei me to paixnidi
// eksigw analutika ti kanei kathe sunartisi parakatw

Ballholder::Ballholder (int N, int L1, int L2, int L3){		// constructor tis ballholder
	int x,i;

	n=N;
	pinakas = new Ball*[n];	// desmeuw dunamika pinaka n thesewn tupou Ball*
	basketball_ok = 0;	// oi treis metrites einai gia tis mpales kathe katigorias pou exoun state=OK
	tennis_ok = 0;		// eksigw sto header ti shmainei kathe katastasi
	pingpong_ok = 0;

	srand(time(NULL));	// kanonika prepei na kalesw mia fora tin srand(tin exw kalesei kai sti main)
	// alla mou edine sunexeia to x ta idia apotelesmata, opote evala alli mia srand
	for (i=0; i<n; i++){
		x= rand() % 3 + 1;	// analoga me to apotelesma tou x dimiourgw mia mpala
		if (x==1) {	// an x==1, ftiaxnw mia mpala basket, ti vazw ston pinaka 
			pinakas[i] = new Basketball(L1);
			basketball_ok ++; // kai auksanw to plithos twn kalwn mpalwn, afou einai h prwti fora pou tis xrhsimopoiw
		}	// kai tous exw kanei arxikopoihsh state = k
		else if (x==2){		// antistoixa kai gia tis alles katigories
			 pinakas[i] = new Tennis(L2);
			 tennis_ok ++;
		}
		else {
			 pinakas[i] = new Pingpong(L3);
			 pingpong_ok ++;
		}
	}
	cout << endl << tennis_ok << " tennis' balls just constructed" << endl;
	cout << pingpong_ok << " pingpong's balls just constructed" << endl;
	cout << basketball_ok << " basketballs just constructed" << endl;
}

Ballholder::~Ballholder(){		// destructor tis ballholder
	int i;	

	for (i=0; i<n; i++) delete pinakas[i];	// katastrefei ton pinaka pou exei desmeutei dunamika 
	delete[] pinakas;
}

int Ballholder::hit_a_ball(){	// xtupaei mia mpala, aneksartita apo ton tupo tis
	int x;
	
	x = rand() % n;
	pinakas[x]->hit();	// xtupaw tuxaia mia mpala
	// an meta to xtupima allaksei to state kai i mpala ginei ftharmeni, spasmeni h eksafanismeni
	// tote oi "kales" mpales meiwnontai kata mia
	// analoga me tin katigoria tis mpalas
	if (pinakas[x]->get_type() == TENNIS && pinakas[x]->get_state() != OK){
		if (tennis_ok > 0) tennis_ok -- ;
	}
	
	if (pinakas[x]->get_type() == BASKETBALL && pinakas[x]->get_state() != OK){
		if (basketball_ok > 0) basketball_ok -- ;
	}
	if (pinakas[x]->get_type() == PINGPONG && pinakas[x]->get_state() != OK){
		if (pingpong_ok > 0) pingpong_ok -- ;
	}
	return x;	// kai gurnaw ti thesi tis mpalas ston pinaka gia na tin ekseresw apo to rest_the_others
}

void Ballholder::rest_the_others(int x){ // kanei rest se oles tis mpales, ektos apo auti sti thesi x pou xtupithike apo ti hit_a_ball
	State previous;	// h prohgoumenh katastash ths mpalas (prin to rest)
	int i;

	for (i=0; i < n; i++){
		if (i==x) continue;	// an i mpala einai auti sti thesi x, de thelw na kanei rest
		previous=pinakas[i]->get_state(); // alliws vriskw tin katastasi tis prin to rest
		pinakas[i]->rest();	// kalw ti rest gia ti mpala
		if (pinakas[i]->get_state() == OK && previous == FTHARMENI){ // an h mpala einai "kalh", kai prin den itan "kalh"
			if (pinakas[i]->get_type()==TENNIS) tennis_ok++;	// tote exw akoma mia mpala "kalh" pou tha 
			else if(pinakas[i]->get_type()==BASKETBALL) basketball_ok++; // paiksei rolo stin epilogi paixnidiou
			else pingpong_ok++;		// sto header.hpp eksigw to "kalh"
		}
	}
}

Type Ballholder::perissoteres_kales(){	// vriskei poios typos exei tis perissoteres kales mpales
	int max;
	
	max = tennis_ok;	// vriskw pois mpales einai oi perissoteres
	if (pingpong_ok > max) max = pingpong_ok;
	if (basketball_ok > max) max = basketball_ok;
	cout << "Remaining balls" << endl; 
	cout << "Tennis' balls: " << tennis_ok << endl;
	cout << "Pingpong's balls: " << pingpong_ok << endl;
	cout << "Basketballs: " << basketball_ok << endl;
	cout << "--------------------------------------------------------------------------------------" << endl;
	if (max == tennis_ok) return TENNIS;	// an einai oi mpales tennis, tote gurizei Type TENNIS
	else if (max == basketball_ok) return BASKETBALL;	// antistoixa gia tis alles 2 kathgories
	else return PINGPONG;
	// apo ti domi tis sunartisis fainetai oti se periptwsi iswn mpalwn i seira proteraiotitas
	// gia to paixnidi pou tha paiksoume einai tennis, basketball, pingpong
}
